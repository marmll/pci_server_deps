/*
  skrill.js (1.0.0)
  Skrill WebPaymentFrontend Javascript Library
  http://github.com/skrill/skrill.js
*/
!function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c=[].slice,d=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};null==window.Skrill&&(window.Skrill={}),null==(a=window.Skrill).callbacks&&(a.callbacks={}),window.Skrill.version="1.0.0",window.Skrill.Core=function(){function a(a){this._validate=b(this._validate,this),this._attachJsonpRequestHandler=b(this._attachJsonpRequestHandler,this);var c;this._formData={},this._sessionId=Skrill.Utils.generateUuid(),null==this.channelId&&this._error("No channelId set"),null==this.merchantId&&this._error("No merchantId set"),"function"==typeof this._debug&&this._debug("Skrill.Core","instance","created"),"function"==typeof this._debug&&this._debug("environment",this.environment),null!=a&&"string"!=typeof a&&this._error("If specified, form id must be a string."),null==a||a.length||this._error("If specified, form id can't be empty."),null!=a&&(c=document.getElementById(a),null!=c?(this._collectFormData(c),c.appendChild(this._metrixTag())):this._error(""+a+" didn't match any existing DOM elements."))}return a.setChannelId=function(a){return this.prototype.channelId=a},a.setMerchantId=function(a){return this.prototype.merchantId=a},a.setEnvironment=function(a){return this.prototype._contains(this.prototype._validEnvironments,a)||this.prototype._error("Environment must be one of "+this.prototype._validEnvironments.join(", ")),this.prototype.environment=a},a.setOrgId=function(a){return this.prototype.orgId=a},a.setDebug=function(a){return this.prototype._debug="function"==typeof a?a:a?function(){var a,b;return a=1<=arguments.length?c.call(arguments,0):[],a.unshift("skrill.js"),"undefined"!=typeof console&&null!==console?null!=(b=console.log)?b.apply(window.console,a):void 0:void 0}:null},a.setRequestTimeout=function(a){return this.prototype._requestTimeout=a},a.on=function(){return this.prototype.on.apply(this.prototype,arguments)},a.prototype._debug=null,a.prototype.environment="production",a.prototype.orgId="k4xv2m4b",a.prototype._validEnvironments=["integration","stage","sandbox","production"],a.prototype._requiredAttributes=["pan","expiry","cvv","amount","currency"],a.prototype._whiteListedAttributes=["recurring"],a.prototype._blacklistedAttributes=["pan","expiry","cvv"],a.prototype._eventCallbacks={},a.prototype._requestTimeout=5e3,a.prototype.on=function(a,b){return"function"==typeof this._debug&&this._debug("event",a,"registered"),this._eventCallbacks[a]=b},a.prototype._trigger=function(){var a,b;return b=arguments[0],a=2<=arguments.length?c.call(arguments,1):[],null!=this._eventCallbacks[b]?("function"==typeof this._debug&&this._debug("event",b,"triggered"),this._eventCallbacks[b].apply(this,a)):void 0},a.prototype._collectFormData=function(a){var b,c,d,e,f,g;for("function"==typeof this._debug&&this._debug("formData","collect"),this._formElement=a,g=a.getElementsByTagName("*"),e=0,f=g.length;f>e;e++)c=g[e],b=c.getAttribute("data-skrill"),d=c.value||null,null!=b&&(this._formData[b]={value:d,element:c});return"function"==typeof this._debug?this._debug("formData","collected",this._formData):void 0},a.prototype._extractPayload=function(a){var b,c,d,e,f,g;null==a&&(a={}),e=a.requiredAttributes,f=a.whiteListedAttributes,e||(e=this._requiredAttributes),f||(f=this._whiteListedAttributes),d={},g=this._formData;for(b in g)c=g[b],(this._contains(e,b)||this._contains(f,b))&&(d[b]=c.element.value,c.element.getAttribute("name")&&this._contains(this._blacklistedAttributes,b)&&(c.element.removeAttribute("name"),"function"==typeof this._debug&&this._debug("removed name attribute",b)));return d},a.prototype.renewToken=function(a){return a||(a=this._extractPayload({requiredAttributes:["cvv"],whiteListedAttributes:["token"]})),this.getToken(a)},a.prototype.getToken=function(a){var b;return a||(a=this._extractPayload()),b=this._validate(a),b===!1&&this._error("payload invalid"),null==a.recurring&&(a.recurring=!1),a.sessionid=this._sessionId,"function"==typeof this._debug&&this._debug("token","get"),this._getJsonp({url:this._tokenizationUrl(),data:a})},a.prototype._tokenizationUrl=function(){var a;return a=function(){switch(this.environment){case"integration":return"https://psp.dev.skrillws.net";case"stage":return"https://psp.dev.moneybookers.net";case"sandbox":return"https://psp.sandbox.dev.skrillws.net";case"production":return"https://psp.skrill.com"}}.call(this),a+("/v1/json/"+this.merchantId+"/"+this.channelId+"/creditcard")},a.prototype._termUrl=function(){switch(this.environment){case"integration":return"https://wpf.dev.skrillws.net/term";case"stage":return"https://wpf.dev.moneybookers.net/term";case"sandbox":return"https://checkout.sandbox.dev.skrillws.net/term";case"production":return"https://checkout.skrill.com/term"}},a.prototype._metrixTag=function(){var a;return a=document.createElement("img"),a.setAttribute("src","https://h.online-metrix.net/fp/clear.png?org_id="+this.orgId+"&session_id="+this._sessionId+"&m=2"),a.setAttribute("alt",""),a},a.prototype._getJsonp=function(a){var b,c,d;return c=document.createElement("script"),b=this._attachJsonpRequestHandler(c),a.data.callback="window.Skrill.callbacks['"+b+"']",a.data.successurl=a.data.errorurl=this._termUrl(),d=this._stringifyUrlParams(a.data),c.src=""+a.url+"?"+d,document.getElementsByTagName("head")[0].appendChild(c),"function"==typeof this._debug?this._debug("jsonp","get"):void 0},a.prototype._attachJsonpRequestHandler=function(a){var b,c,d,e=this;return this._jsonpRequestComplete=!1,"function"==typeof this._debug&&this._debug("callbackHandler","attach"),b="skrill_"+(new Date).getTime(),c=function(c){return c.callbackLabel&&delete window.Skrill.callbacks[b],c.script&&e._removeDomElement(a),c.timeout?window.clearTimeout(d):void 0},d=window.setTimeout(function(){return e._jsonpRequestComplete?void 0:(a.onerror=null,c({script:a,callbackLabel:b}),"function"==typeof e._debug&&e._debug("network_error","timeout"),e._trigger("network_error",{message:"request timed out"}))},this._requestTimeout),a.onerror=function(f){return c({script:a,callbackLabel:b,timeout:d}),e._trigger("network_error",f.target)},window.Skrill.callbacks[b]=function(f){var g;return window.clearTimeout(d),e._jsonpRequestComplete=!0,"function"==typeof e._debug&&e._debug("jsonp","response",f),Skrill.Utils.responseError(f)?e._trigger("token_error",{message:f.message||"General Error",advice:f.advice||"Please contact a Skrill service representative."}):null!=f.processing?e._trigger("threedsecure",new Skrill.Utils.Threed(f.processing,e)):(null!=(g=f.account)?g.token:void 0)?(e._token===f.account.token&&"function"==typeof e._debug&&e._debug("re-fetched existing token!"),e._token=f.account.token,e._trigger("token_generated",f.account)):("function"==typeof e._debug&&e._debug("unknown response",f),e._trigger("network_error")),c({script:a,callbackLabel:b})},b},a.prototype._removeDomElement=function(a){return Skrill.Utils.removeDomElement(a)},a.prototype._stringifyUrlParams=function(a){var b,c,d;return c=function(){var c;c=[];for(b in a)d=a[b],c.push(""+b+"="+encodeURIComponent(d));return c}(),c.join("&").replace(/%20/g,"+")},a.prototype._contains=function(a,b){return d.call(a,b)>=0},a.prototype.validateAttribute=function(a,b){var c;return b=b.replace(/\s+|-/g,""),null!=(c=this._validationRules[a])?c.call(this,b):void 0},a.prototype._validate=function(a){var b,c,d,e,f;if(null==a)return"payload cannot be empty";b=[];for(c in a)d=a[c],this._contains(this._requiredAttributes,c)?d&&this.validateAttribute.call(this,c,d)||b.push({attribute:c,value:d,element:(null!=(e=this._formData[c])?e.element:void 0)||null}):(null==d||""===d)&&b.push({attribute:c,value:d,element:(null!=(f=this._formData[c])?f.element:void 0)||null});return b.length?(this._trigger("attribute_invalid",b),!!b.length):void 0},a.prototype._validationRules={pan:function(a){return a.length>=10&&a.length<=16&&this._luhnCheck(a)},expiry:function(a){var b,c,d,e,f,g;return/^\d{1,2}\/\d{4}$/.test(a)&&(g=function(){var c,d,e,f;for(e=a.split("/"),f=[],c=0,d=e.length;d>c;c++)b=e[c],f.push(parseInt(b,10));return f}(),d=g[0],f=g[1],d>0&&12>=d)?(c=new Date(f,d,0),e=new Date,c>=e):!1},amount:function(a){return/^\d+$/.test(a)},currency:function(a){return/^[A-Z]{3}$/.test(a)},cvv:function(a){var b,c;return/^\d+$/.test(a)?null!=this._formData.pan?(b=a.length,d.call(Skrill.Utils.cvvLength(this._formData.pan.element.value),b)>=0):3<=(c=a.length)&&4>=c:!1}},a.prototype._luhnCheck=function(a){var b,c,d,e,f,g,h,i;for(g=!0,f=c=0,d=function(){var b,c,d,f;for(d=String(a).split("").reverse(),f=[],b=0,c=d.length;c>b;b++)e=d[b],f.push(parseInt(e,10));return f}(),h=0,i=d.length;i>h;h++)b=d[h],(g=!g)&&(b*=2),b>9&&(b-=9),f+=b;return 0===f%10},a.prototype._error=function(a){throw new Error(a)},a}(),null==window.Skrill&&(window.Skrill={}),window.Skrill.Utils={generateUuid:function(){var a;return a=(new Date).getTime(),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(b){var c;return c=0|(a+16*Math.random())%16,a=Math.floor(a/16),("x"===b?c:8|7&c).toString(16)})},responseError:function(a){return 0!==a.level&&0!==a.code},parseJson:function(a){var b;return null!=(null!=(b=window.JSON)?b.parse:void 0)?window.JSON.parse(a):"string"!=typeof a?a:Skrill.Utils._parseJson(a)},_parseJson:function(a){var b,c,d,e,f;if(b=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,d=/^[\],:{}\s]*$/,c=/(?:^|:|,)(?:\s*\[)+/g,e=/\\(?:["\\\/bfnrt]|u[\da-fA-F]{4})/g,f=/"[^"\\\r\n]*"|true|false|null|-?(?:\d+\.|)\d+(?:[eE][+-]?\d+|)/g,a=String(a).replace(b,""),a&&d.test(a.replace(e,"@").replace(f,"]").replace(c,"")))return new Function("return "+a)();throw new SyntaxError("Invalid JSON")},postMessage:function(a,b){return b||(b=parent),null!=window.postMessage?b.postMessage(a,"*"):Skrill.Utils._postMessage(a,b)},_postMessage:function(a,b){return b.name=a},onMessage:function(a){var b,c;return null!=window.postMessage?(b=null!=window.addEventListener?"addEventListener":"attachEvent",c="attachEvent"===b?"onmessage":"message",window[b](c,function(b){var c;return c=window.Skrill.Utils.parseJson(b.data),a.call(this,c)},!1)):Skrill.Utils._onMessage(a)},_onMessage:function(a){var b;return"undefined"!=typeof b&&null!==b&&clearInterval(b),b=setInterval(function(){var b;return b=window.name,b?(window.name="",b=window.Skrill.Utils.parseJson(b),a.call(this,b)):void 0},100)},addClass:function(a,b){var c;return c=b.className.split(" "),c.push(a),b.className=c.join(" ")},removeClass:function(a,b){var c,d,e,f,g,h;for(c=b.className.split(" "),d=g=0,h=c.length;h>g;d=++g)e=c[d],a===e&&c.splice(d,1);return f=c.join(" "),b.className=f},cvvLength:function(a){return"unknown"===this.brand(a)?[3,4]:"amex"===this.brand(a)?[4]:[3]},brand:function(a){return this.brands()[a.slice(0,2)]||"unknown"},brands:function(){var a,b,c,d,e,f,g,h,i,j,k,l,m;for(a={},b=c=40;49>=c;b=++c)a[b]="visa";for(b=d=50;59>=d;b=++d)a[b]="mastercard";for(k=[34,37],e=0,g=k.length;g>e;e++)b=k[e],a[b]="amex";for(l=[60,62,64,65],f=0,h=l.length;h>f;f++)b=l[f],a[b]="discover";for(m=[30,36,38,39],j=0,i=m.length;i>j;j++)b=m[j],a[b]="dinersclub";return a[35]="jcb",a},removeDomElement:function(a){var b;return null!=(b=a.parentNode)?b.removeChild(a):void 0}},Skrill.Utils.Threed=function(){function a(a,b){var c,d,e,f,g,h;this.response=a,this.skrillInstance=b,"function"==typeof(e=Skrill.Core.prototype)._debug&&e._debug("Threed","instance","created");try{this.iframe=document.createElement('<iframe name="skrill-3dsecure" />')}catch(i){this.iframe=document.createElement("iframe"),this.iframe.setAttribute("name","skrill-3dsecure")}for(this.form=document.createElement("form"),this.iframe.setAttribute("frameBorder","0"),this.iframe.setAttribute("seamless",!0),h=["TermUrl","PaReq","MD"],f=0,g=h.length;g>f;f++)d=h[f],c=document.createElement("input"),c.setAttribute("type","hidden"),c.setAttribute("name",d),c.setAttribute("value",this.response[d.toLowerCase()]),this.form.appendChild(c);this.form.setAttribute("target","skrill-3dsecure"),this.form.setAttribute("method","POST"),this.form.setAttribute("action",this.response.redirecturl),document.body.appendChild(this.form)}return a.prototype.start=function(){var a,b=this;return"function"==typeof(a=Skrill.Core.prototype)._debug&&a._debug("Threed","started"),this.form.submit(),window.Skrill.Utils.onMessage(function(a){var c,d,e,f;return"function"==typeof(c=Skrill.Core.prototype)._debug&&c._debug("Threed","onMessage","response",a),Skrill.Utils.removeDomElement(b.iframe),Skrill.Utils.removeDomElement(b.form),Skrill.Utils.responseError(a)?("function"==typeof(d=Skrill.Core.prototype)._debug&&d._debug("Threed","onMessage","error"),b.skrillInstance._trigger("token_error",{message:a.message||"General Error",advice:a.advice||"Please contact a Skrill service representative."})):(null!=(f=a.account)?f.token:void 0)?("function"==typeof(e=Skrill.Core.prototype)._debug&&e._debug("Threed","onMessage","success"),b.skrillInstance._trigger("token_generated",a.account)):void 0})},a}()}.call(this);